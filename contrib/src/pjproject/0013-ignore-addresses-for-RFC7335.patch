From 0f901bec66f65b8268e8b2eaa89f0c7aa1bdf0ea Mon Sep 17 00:00:00 2001
From: Mohamed Chibani <mohamed.chibani@savoirfairelinux.com>
Date: Thu, 26 Aug 2021 10:41:39 -0400
Subject: [PATCH 13/20] ignore-addresses-for-RFC7335

---
 pjlib/src/pj/ip_helper_generic.c | 30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git a/pjlib/src/pj/ip_helper_generic.c b/pjlib/src/pj/ip_helper_generic.c
index 2a392d16b..c1e49c3d3 100644
--- a/pjlib/src/pj/ip_helper_generic.c
+++ b/pjlib/src/pj/ip_helper_generic.c
@@ -121,6 +121,16 @@ static pj_status_t if_enum_by_af(int af,
 	    continue; /* Skip when interface is down */
 	}
 
+	/* Ignore 192.0.0.0/29 address. cf https://datatracker.ietf.org/doc/html/rfc7335#section-4
+	 */
+	if (af==pj_AF_INET() &&
+	    (pj_ntohl(((pj_sockaddr_in*)ad)->sin_addr.s_addr) >> 4) == 201326592 /* 0b1100000000000000000000000000 which is 192.0.0.0 >> 4 */)
+	{
+	    TRACE_((THIS_FILE, "  address %s ignored (192.0.0.0/29 class)",
+		    get_addr(ad), ad->sa_family));
+	    continue;
+	}
+
 	/* Ignore 0.0.0.0/8 address. This is a special address
 	 * which doesn't seem to have practical use.
 	 */
@@ -225,6 +235,16 @@ static pj_status_t if_enum_by_af(int af,
 	}
 #endif
 
+	/* Ignore 192.0.0.0/29 address. cf https://datatracker.ietf.org/doc/html/rfc7335#section-4
+	 */
+	if (af==pj_AF_INET() &&
+	    (pj_ntohl(((pj_sockaddr_in*)ad)->sin_addr.s_addr) >> 4) == 201326592 /* 0b1100000000000000000000000000 which is 192.0.0.0 >> 4 */)
+	{
+	    TRACE_((THIS_FILE, "  address %s ignored (192.0.0.0/29 class)",
+		    get_addr(ad), ad->sa_family));
+	    continue;
+	}
+
 	/* Ignore 0.0.0.0/8 address. This is a special address
 	 * which doesn't seem to have practical use.
 	 */
@@ -324,6 +344,16 @@ static pj_status_t if_enum_by_af(int af, unsigned *p_cnt, pj_sockaddr ifs[])
 	    continue;	/* Not address family that we want, continue */
 	}
 
+	/* Ignore 192.0.0.0/29 address. cf https://datatracker.ietf.org/doc/html/rfc7335#section-4
+	 */
+	if (af==pj_AF_INET() &&
+	    (pj_ntohl(((pj_sockaddr_in*)ad)->sin_addr.s_addr) >> 4) == 201326592 /* 0b1100000000000000000000000000 which is 192.0.0.0 >> 4 */)
+	{
+	    TRACE_((THIS_FILE, "  address %s ignored (192.0.0.0/29 class)",
+		    get_addr(ad), ad->sa_family));
+	    continue;
+	}
+
 	/* Ignore 0.0.0.0/8 address. This is a special address
 	 * which doesn't seem to have practical use.
 	 */
-- 
2.25.1

