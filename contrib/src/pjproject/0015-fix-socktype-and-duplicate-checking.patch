From 2feee8db77ed47e7b574367295d4f03f9aea67f8 Mon Sep 17 00:00:00 2001
From: sauwming <ming@teluu.com>
Date: Fri, 6 Aug 2021 09:45:54 +0800
Subject: [PATCH] Fix socktype and duplicate checking in pj_getaddrinfo()

---
 pjlib/src/pj/addr_resolv_sock.c | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/pjlib/src/pj/addr_resolv_sock.c b/pjlib/src/pj/addr_resolv_sock.c
index f68c4b177..0954f2ee0 100644
--- a/pjlib/src/pj/addr_resolv_sock.c
+++ b/pjlib/src/pj/addr_resolv_sock.c
@@ -197,15 +197,20 @@ PJ_DEF(pj_status_t) pj_getaddrinfo(int af, const pj_str_t *nodename,
 	if (af!=PJ_AF_UNSPEC && res->ai_family != af)
 	    continue;
 
-	if (res->ai_socktype != pj_SOCK_DGRAM()
-                    && res->ai_socktype != pj_SOCK_STREAM()) {
+	if (res->ai_socktype != pj_SOCK_DGRAM() &&
+            res->ai_socktype != pj_SOCK_STREAM() &&
+            /* It is possible that the result's sock type
+             * is unspecified.
+             */
+            res->ai_socktype != 0)
+        {
 	        continue;
 	}
 
 	/* Add current address in the resulting list if there
 	 * is no duplicates only. */
 	for (j = 0; j < i; j++) {
-	    if (!pj_memcmp(&ai[j].ai_addr, res->ai_addr, res->ai_addrlen)) {
+	    if (!pj_sockaddr_cmp(&ai[j].ai_addr, res->ai_addr)) {
 		duplicate_found = PJ_TRUE;
 		break;
 	    }