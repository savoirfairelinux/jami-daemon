From ad0d7b79b78247cb59e3e440094fc779b2ab7957 Mon Sep 17 00:00:00 2001
From: Sebastien Blin <sebastien.blin@savoirfairelinux.com>
Date: Wed, 7 Mar 2018 17:21:58 -0500
Subject: [PATCH] temp

---
 asio/include/asio/ssl/detail/impl/engine.ipp       | 12 ++++++++++++
 asio/include/asio/ssl/detail/impl/openssl_init.ipp |  3 +++
 2 files changed, 15 insertions(+)

diff --git a/include/asio/ssl/detail/impl/engine.ipp b/include/asio/ssl/detail/impl/engine.ipp
index 345461b1..d3cacd0d 100644
--- a/include/asio/ssl/detail/impl/engine.ipp
+++ b/include/asio/ssl/detail/impl/engine.ipp
@@ -197,7 +197,13 @@ const asio::error_code& engine::map_error_code(
   // If there's data yet to be read, it's an error.
   if (BIO_wpending(ext_bio_))
   {
+#if defined(OPENSSL_IS_BORINGSSL)
+    ec = asio::error_code(
+        ERR_PACK(ERR_LIB_SSL, SSL_R_UNEXPECTED_RECORD),
+        asio::error::get_ssl_category());
+#else // defined(OPENSSL_IS_BORINGSSL)
     ec = asio::ssl::error::stream_truncated;
+#endif // defined(OPENSSL_IS_BORINGSSL)
     return ec;
   }

@@ -211,7 +217,13 @@ const asio::error_code& engine::map_error_code(
   // Otherwise, the peer should have negotiated a proper shutdown.
   if ((::SSL_get_shutdown(ssl_) & SSL_RECEIVED_SHUTDOWN) == 0)
   {
+#if defined(OPENSSL_IS_BORINGSSL)
+    ec = asio::error_code(
+        ERR_PACK(ERR_LIB_SSL, SSL_R_UNEXPECTED_RECORD),
+        asio::error::get_ssl_category());
+#else // defined(OPENSSL_IS_BORINGSSL)
     ec = asio::ssl::error::stream_truncated;
+#endif // defined(OPENSSL_IS_BORINGSSL)
   }

   return ec;
diff --git a/include/asio/ssl/detail/impl/openssl_init.ipp b/include/asio/ssl/detail/impl/openssl_init.ipp
index 75aefec0..04c27588 100644
--- a/include/asio/ssl/detail/impl/openssl_init.ipp
+++ b/include/asio/ssl/detail/impl/openssl_init.ipp
@@ -72,6 +72,9 @@ public:
     ::ERR_free_strings();
     ::EVP_cleanup();
     ::CRYPTO_cleanup_all_ex_data();
+#if !defined(OPENSSL_IS_BORINGSSL)
+     ::CONF_modules_unload(1);
+#endif
 #endif // (OPENSSL_VERSION_NUMBER < 0x10100000L)
 #if (OPENSSL_VERSION_NUMBER < 0x10000000L)
     ::ERR_remove_state(0);
--
2.14.3
